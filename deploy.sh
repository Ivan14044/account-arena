#!/bin/bash

###############################################################################
# Ð¡ÐšÐ Ð˜ÐŸÐ¢ Ð”Ð•ÐŸÐ›ÐžÐ¯ ÐŸÐ ÐžÐ•ÐšÐ¢Ð SUBCLOUDY (ACCOUNT ARENA)
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑÑ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð¿Ð¾ÑÐ»Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð² ÐºÐ¾Ð´Ðµ
###############################################################################

set -e

echo "=========================================="
echo "ðŸš€ ÐÐÐ§ÐÐ›Ðž Ð”Ð•ÐŸÐ›ÐžÐ¯ ÐŸÐ ÐžÐ•ÐšÐ¢Ð"
echo "=========================================="
echo ""

# Ð¦Ð²ÐµÑ‚Ð°
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

info() {
    echo -e "${YELLOW}â„¹ï¸  $1${NC}"
}

PROJECT_DIR="/var/www/subcloudy"

###############################################################################
# ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ Ð¡Ð£Ð©Ð•Ð¡Ð¢Ð’ÐžÐ’ÐÐÐ˜Ð¯ ÐŸÐ ÐžÐ•ÐšÐ¢Ð
###############################################################################
if [ ! -d "$PROJECT_DIR" ]; then
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ $PROJECT_DIR Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚!"
    echo "Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð² ÑÑ‚Ñƒ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ."
    exit 1
fi

###############################################################################
# Ð¨ÐÐ“ 1: ÐžÐ‘ÐÐžÐ’Ð›Ð•ÐÐ˜Ð• ÐšÐžÐ”Ð (Ð•Ð¡Ð›Ð˜ Ð­Ð¢Ðž GIT Ð Ð•ÐŸÐžÐ—Ð˜Ð¢ÐžÐ Ð˜Ð™)
###############################################################################
if [ -d "$PROJECT_DIR/.git" ]; then
    info "Ð¨ÐÐ“ 1: ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð´Ð° Ð¸Ð· Git..."
    cd $PROJECT_DIR
    git pull origin main || git pull origin master
    success "ÐšÐ¾Ð´ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½"
else
    info "Ð¨ÐÐ“ 1: Git Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼..."
fi
echo ""

###############################################################################
# Ð¨ÐÐ“ 2: Ð”Ð•ÐŸÐ›ÐžÐ™ BACKEND (LARAVEL)
###############################################################################
info "Ð¨ÐÐ“ 2: Ð”ÐµÐ¿Ð»Ð¾Ð¹ Backend (Laravel)..."

if [ ! -d "$PROJECT_DIR/backend" ]; then
    echo "âŒ ÐŸÐ°Ð¿ÐºÐ° backend Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°!"
    exit 1
fi

cd $PROJECT_DIR/backend

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° .env Ñ„Ð°Ð¹Ð»Ð°
if [ ! -f ".env" ]; then
    echo "âŒ Ð¤Ð°Ð¹Ð» .env Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
    echo "Ð¡Ð¾Ð·Ð´Ð°Ð¹ ÐµÐ³Ð¾: cp .env.example .env Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹"
    exit 1
fi

# Ð ÐµÐ¶Ð¸Ð¼ Ð¾Ð±ÑÐ»ÑƒÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ
php artisan down

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Composer
info "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Composer..."
composer install --optimize-autoloader --no-dev

# ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸
info "Ð—Ð°Ð¿ÑƒÑÐº Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹..."
php artisan migrate --force

# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¸ ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
info "ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¸ ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ..."
php artisan cache:clear
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð²
info "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°..."
chown -R www-data:www-data $PROJECT_DIR/backend
chmod -R 755 $PROJECT_DIR/backend
chmod -R 775 $PROJECT_DIR/backend/storage
chmod -R 775 $PROJECT_DIR/backend/bootstrap/cache

# Ð’Ñ‹Ñ…Ð¾Ð´ Ð¸Ð· Ñ€ÐµÐ¶Ð¸Ð¼Ð° Ð¾Ð±ÑÐ»ÑƒÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ
php artisan up

success "Backend Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½"
echo ""

###############################################################################
# Ð¨ÐÐ“ 3: Ð”Ð•ÐŸÐ›ÐžÐ™ FRONTEND (VUE)
###############################################################################
info "Ð¨ÐÐ“ 3: Ð”ÐµÐ¿Ð»Ð¾Ð¹ Frontend (Vue)..."

if [ ! -d "$PROJECT_DIR/frontend" ]; then
    echo "âŒ ÐŸÐ°Ð¿ÐºÐ° frontend Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°!"
    exit 1
fi

cd $PROJECT_DIR/frontend

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° .env Ñ„Ð°Ð¹Ð»Ð°
if [ ! -f ".env" ]; then
    echo "âš ï¸  Ð¤Ð°Ð¹Ð» .env Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, ÑÐ¾Ð·Ð´Ð°ÑŽ..."
    cat > .env <<EOF
VITE_API_URL=https://account-arena.com/api
VITE_APP_URL=https://account-arena.com
EOF
fi

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ npm
info "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ npm..."
npm install

# Ð¡Ð±Ð¾Ñ€ÐºÐ° production Ð²ÐµÑ€ÑÐ¸Ð¸
info "Ð¡Ð±Ð¾Ñ€ÐºÐ° production Ð²ÐµÑ€ÑÐ¸Ð¸..."
npm run build

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð²
info "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°..."
chown -R www-data:www-data $PROJECT_DIR/frontend/dist

success "Frontend Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½"
echo ""

###############################################################################
# Ð¨ÐÐ“ 4: ÐŸÐ•Ð Ð•Ð—ÐÐŸÐ£Ð¡Ðš Ð¡Ð•Ð Ð’Ð˜Ð¡ÐžÐ’
###############################################################################
info "Ð¨ÐÐ“ 4: ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."

systemctl restart php8.2-fpm
systemctl restart nginx
systemctl restart laravel-worker

success "Ð¡ÐµÑ€Ð²Ð¸ÑÑ‹ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹"
echo ""

###############################################################################
# Ð¨ÐÐ“ 5: ÐžÐ§Ð˜Ð¡Ð¢ÐšÐ
###############################################################################
info "Ð¨ÐÐ“ 5: ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
cd $PROJECT_DIR/backend
php artisan optimize:clear
success "ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"
echo ""

###############################################################################
# Ð¤Ð˜ÐÐÐ›
###############################################################################
echo "=========================================="
echo -e "${GREEN}âœ… Ð”Ð•ÐŸÐ›ÐžÐ™ Ð—ÐÐ’Ð•Ð Ð¨Ð•Ð Ð£Ð¡ÐŸÐ•Ð¨ÐÐž!${NC}"
echo "=========================================="
echo ""
echo "ðŸŒ Ð¡Ð°Ð¹Ñ‚: https://account-arena.com"
echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²:"
echo ""
systemctl status nginx --no-pager -l | grep Active
systemctl status php8.2-fpm --no-pager -l | grep Active
systemctl status laravel-worker --no-pager -l | grep Active
echo ""
echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ Ð»Ð¾Ð³Ð¸, ÐµÑÐ»Ð¸ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚:"
echo "   tail -f /var/log/nginx/account-arena-error.log"
echo "   tail -f /var/www/subcloudy/backend/storage/logs/laravel.log"
echo ""
echo "ðŸŽ‰ Ð“Ð¾Ñ‚Ð¾Ð²Ð¾!"
echo ""


