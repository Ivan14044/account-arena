#!/bin/bash

###############################################################################
# Account Arena - –°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ push –Ω–∞ GitHub
# –í–µ—Ä—Å–∏—è: 2.0
###############################################################################

set -e

# –¶–≤–µ—Ç–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_header() {
    echo -e "\n${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${BLUE}‚ïë${NC} $1"
    echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}\n"
}

print_success() {
    echo -e "${GREEN}‚úì${NC} $1"
}

print_info() {
    echo -e "${YELLOW}‚Ñπ${NC} $1"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ root –ø—Ä–∞–≤
if [ "$EUID" -ne 0 ]; then 
    echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–∞–≤–∞–º–∏ root (sudo)"
    exit 1
fi

print_header "üîÑ –û–ë–ù–û–í–õ–ï–ù–ò–ï ACCOUNT ARENA"

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /var/www/account-arena

print_info "–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ GitHub..."
git pull origin main

###############################################################################
# –û–ë–ù–û–í–õ–ï–ù–ò–ï BACKEND
###############################################################################
print_header "‚öôÔ∏è  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Backend"

cd backend

print_info "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
composer install --no-dev --optimize-autoloader --no-interaction

print_info "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
php artisan migrate --force

print_info "–û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞..."
php artisan cache:clear > /dev/null 2>&1 || true
php artisan config:clear > /dev/null 2>&1 || true
php artisan route:clear > /dev/null 2>&1 || true
php artisan view:clear > /dev/null 2>&1 || true

print_info "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è..."
php artisan config:cache
php artisan route:cache
php artisan view:cache
php artisan optimize

print_success "Backend –æ–±–Ω–æ–≤–ª—ë–Ω"

###############################################################################
# –û–ë–ù–û–í–õ–ï–ù–ò–ï FRONTEND
###############################################################################
print_header "üé® –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Frontend"

cd ../frontend

print_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm install --silent

print_info "–°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
npm run build

print_success "Frontend –æ–±–Ω–æ–≤–ª—ë–Ω"

###############################################################################
# –£–°–¢–ê–ù–û–í–ö–ê –ü–†–ê–í
###############################################################################
print_header "üîê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞"

cd /var/www/account-arena
chown -R www-data:www-data .
chmod -R 775 backend/storage backend/bootstrap/cache

print_success "–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã"

###############################################################################
# –ü–ï–†–ï–ó–ê–ü–£–°–ö –°–ï–†–í–ò–°–û–í
###############################################################################
print_header "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤"

systemctl restart php8.2-fpm
systemctl reload nginx
systemctl restart account-arena-worker 2>/dev/null || true

print_success "–°–µ—Ä–≤–∏—Å—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã"

###############################################################################
# –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê
###############################################################################
print_header "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞"

systemctl is-active --quiet nginx && print_success "Nginx —Ä–∞–±–æ—Ç–∞–µ—Ç" || echo "‚ùå Nginx –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
systemctl is-active --quiet php8.2-fpm && print_success "PHP-FPM —Ä–∞–±–æ—Ç–∞–µ—Ç" || echo "‚ùå PHP-FPM –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
systemctl is-active --quiet mysql && print_success "MySQL —Ä–∞–±–æ—Ç–∞–µ—Ç" || echo "‚ùå MySQL –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
systemctl is-active --quiet redis-server && print_success "Redis —Ä–∞–±–æ—Ç–∞–µ—Ç" || echo "‚ùå Redis –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
systemctl is-active --quiet account-arena-worker && print_success "Queue Worker —Ä–∞–±–æ—Ç–∞–µ—Ç" || echo "‚ö†Ô∏è Queue Worker –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"

print_header "üéâ –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!"
